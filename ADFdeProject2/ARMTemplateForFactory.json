{
	"$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
	"contentVersion": "1.0.0.0",
	"parameters": {
		"factoryName": {
			"type": "string",
			"metadata": "Data Factory name",
			"defaultValue": "ADFdeProject2"
		},
		"ds_json_data_connectionString": {
			"type": "secureString",
			"metadata": "Secure string for 'connectionString' of 'ds_json_data'"
		},
		"ls_adls_gen2_accountKey": {
			"type": "secureString",
			"metadata": "Secure string for 'accountKey' of 'ls_adls_gen2'"
		},
		"airQualityAPI_properties_typeProperties_url": {
			"type": "string",
			"defaultValue": "https://api.waqi.info/feed"
		},
		"ls_adls_gen2_properties_typeProperties_url": {
			"type": "string",
			"defaultValue": "https://deprojectsagen2.dfs.core.windows.net/"
		},
		"weatherAPI_properties_typeProperties_url": {
			"type": "string",
			"defaultValue": "https://weather.visualcrossing.com/VisualCrossingWebServices/rest/services/timeline"
		}
	},
	"variables": {
		"factoryId": "[concat('Microsoft.DataFactory/factories/', parameters('factoryName'))]"
	},
	"resources": [
		{
			"name": "[concat(parameters('factoryName'), '/data processing pipeline')]",
			"type": "Microsoft.DataFactory/factories/pipelines",
			"apiVersion": "2018-06-01",
			"properties": {
				"activities": [
					{
						"name": "ForEach1",
						"type": "ForEach",
						"dependsOn": [],
						"userProperties": [],
						"typeProperties": {
							"items": {
								"value": "@variables('cities')",
								"type": "Expression"
							},
							"activities": [
								{
									"name": "Data flow1_copy1",
									"type": "ExecuteDataFlow",
									"dependsOn": [],
									"policy": {
										"timeout": "0.12:00:00",
										"retry": 0,
										"retryIntervalInSeconds": 30,
										"secureOutput": false,
										"secureInput": false
									},
									"userProperties": [],
									"typeProperties": {
										"dataflow": {
											"referenceName": "weather_data_df",
											"type": "DataFlowReference",
											"parameters": {},
											"datasetParameters": {
												"weatherDataRaw": {
													"city": "@{item()}",
													"file_type": ".json"
												},
												"processedWeatherData": {}
											}
										},
										"staging": {},
										"compute": {
											"coreCount": 8,
											"computeType": "General"
										},
										"traceLevel": "Fine"
									}
								}
							]
						}
					}
				],
				"policy": {
					"elapsedTimeMetric": {},
					"cancelAfter": {}
				},
				"variables": {
					"cities": {
						"type": "Array",
						"defaultValue": [
							"Toronto",
							"Vancouver",
							"Montreal",
							"Ottawa",
							"Calgary",
							"Edmonton",
							"Quebec City",
							"Halifax",
							"Winnipeg",
							"Victoria",
							"Seattle",
							"New York",
							"Los Angeles",
							"Chicago",
							"San Francisco",
							"Miami",
							"Las Vegas",
							"Boston",
							"London",
							"Paris",
							"Berlin",
							"Madrid",
							"Rome",
							"Amsterdam",
							"Vienna",
							"Prague",
							"Dublin",
							"Barcelona",
							"Stockholm",
							"Copenhagen"
						]
					}
				},
				"annotations": []
			},
			"dependsOn": [
				"[concat(variables('factoryId'), '/dataflows/weather_data_df')]"
			]
		},
		{
			"name": "[concat(parameters('factoryName'), '/pipeline1')]",
			"type": "Microsoft.DataFactory/factories/pipelines",
			"apiVersion": "2018-06-01",
			"properties": {
				"activities": [
					{
						"name": "extract data",
						"type": "ForEach",
						"dependsOn": [],
						"userProperties": [],
						"typeProperties": {
							"items": {
								"value": "@variables('cities')",
								"type": "Expression"
							},
							"activities": [
								{
									"name": "get api data",
									"type": "Copy",
									"dependsOn": [],
									"policy": {
										"timeout": "0.12:00:00",
										"retry": 0,
										"retryIntervalInSeconds": 30,
										"secureOutput": false,
										"secureInput": false
									},
									"userProperties": [],
									"typeProperties": {
										"source": {
											"type": "RestSource",
											"httpRequestTimeout": "00:01:40",
											"requestInterval": "00.00:00:00.010",
											"requestMethod": "GET",
											"paginationRules": {
												"supportRFC5988": "true"
											}
										},
										"sink": {
											"type": "JsonSink",
											"storeSettings": {
												"type": "AzureBlobStorageWriteSettings"
											},
											"formatSettings": {
												"type": "JsonWriteSettings"
											}
										},
										"enableStaging": false
									},
									"inputs": [
										{
											"referenceName": "ds_rest_api_data",
											"type": "DatasetReference",
											"parameters": {
												"URL_path": {
													"value": "@{item()}",
													"type": "Expression"
												},
												"token": "?token=240d2b420f4746e98e44655f7ceb7c2e738cd219"
											}
										}
									],
									"outputs": [
										{
											"referenceName": "Json1",
											"type": "DatasetReference",
											"parameters": {
												"city": {
													"value": "@item()",
													"type": "Expression"
												}
											}
										}
									]
								}
							]
						}
					}
				],
				"policy": {
					"elapsedTimeMetric": {},
					"cancelAfter": {}
				},
				"variables": {
					"cities": {
						"type": "Array",
						"defaultValue": [
							"Toronto",
							"Vancouver",
							"Montreal",
							"Ottawa",
							"Calgary",
							"Edmonton",
							"Quebec City",
							"Halifax",
							"Winnipeg",
							"Victoria",
							"Seattle",
							"New York",
							"Los Angeles",
							"Chicago",
							"San Francisco",
							"Miami",
							"Las Vegas",
							"Boston",
							"London",
							"Paris",
							"Berlin",
							"Madrid",
							"Rome",
							"Amsterdam",
							"Vienna",
							"Prague",
							"Dublin",
							"Barcelona",
							"Stockholm",
							"Copenhagen"
						]
					}
				},
				"annotations": [],
				"lastPublishTime": "2023-07-13T21:13:10Z"
			},
			"dependsOn": [
				"[concat(variables('factoryId'), '/datasets/ds_rest_api_data')]",
				"[concat(variables('factoryId'), '/datasets/Json1')]"
			]
		},
		{
			"name": "[concat(parameters('factoryName'), '/pipeline2')]",
			"type": "Microsoft.DataFactory/factories/pipelines",
			"apiVersion": "2018-06-01",
			"properties": {
				"activities": [
					{
						"name": "extract data 2",
						"type": "ForEach",
						"dependsOn": [],
						"userProperties": [],
						"typeProperties": {
							"items": {
								"value": "@variables('cities')",
								"type": "Expression"
							},
							"activities": [
								{
									"name": "Copy data 2",
									"type": "Copy",
									"dependsOn": [],
									"policy": {
										"timeout": "0.12:00:00",
										"retry": 0,
										"retryIntervalInSeconds": 30,
										"secureOutput": false,
										"secureInput": false
									},
									"userProperties": [],
									"typeProperties": {
										"source": {
											"type": "RestSource",
											"httpRequestTimeout": "00:01:40",
											"requestInterval": "00.00:00:00.010",
											"requestMethod": "GET",
											"paginationRules": {
												"supportRFC5988": "true"
											}
										},
										"sink": {
											"type": "JsonSink",
											"storeSettings": {
												"type": "AzureBlobStorageWriteSettings"
											},
											"formatSettings": {
												"type": "JsonWriteSettings"
											}
										},
										"enableStaging": false
									},
									"inputs": [
										{
											"referenceName": "ds_weatherAPI",
											"type": "DatasetReference",
											"parameters": {
												"location": {
													"value": "@{item()}",
													"type": "Expression"
												},
												"date": "/2023-07-16/2023-07-16",
												"apiKey": "?unitGroup=metric&key=W6EB6VYPKBKX3KKJ2HZF94K2V&contentType=json"
											}
										}
									],
									"outputs": [
										{
											"referenceName": "ds_weatherData_json",
											"type": "DatasetReference",
											"parameters": {
												"city": {
													"value": "@{item()}",
													"type": "Expression"
												},
												"file_type": ".json"
											}
										}
									]
								}
							]
						}
					}
				],
				"policy": {
					"elapsedTimeMetric": {},
					"cancelAfter": {}
				},
				"variables": {
					"cities": {
						"type": "Array",
						"defaultValue": [
							"Toronto",
							"Vancouver",
							"Montreal",
							"Ottawa",
							"Calgary",
							"Edmonton",
							"Quebec City",
							"Halifax",
							"Winnipeg",
							"Victoria",
							"Seattle",
							"New York",
							"Los Angeles",
							"Chicago",
							"San Francisco",
							"Miami",
							"Las Vegas",
							"Boston",
							"London",
							"Paris",
							"Berlin",
							"Madrid",
							"Rome",
							"Amsterdam",
							"Vienna",
							"Prague",
							"Dublin",
							"Barcelona",
							"Stockholm",
							"Copenhagen"
						]
					}
				},
				"annotations": []
			},
			"dependsOn": [
				"[concat(variables('factoryId'), '/datasets/ds_weatherAPI')]",
				"[concat(variables('factoryId'), '/datasets/ds_weatherData_json')]"
			]
		},
		{
			"name": "[concat(parameters('factoryName'), '/Json1')]",
			"type": "Microsoft.DataFactory/factories/datasets",
			"apiVersion": "2018-06-01",
			"properties": {
				"linkedServiceName": {
					"referenceName": "ds_json_data",
					"type": "LinkedServiceReference"
				},
				"parameters": {
					"city": {
						"type": "string"
					}
				},
				"annotations": [],
				"type": "Json",
				"typeProperties": {
					"location": {
						"type": "AzureBlobStorageLocation",
						"fileName": {
							"value": "@concat('AQ_', dataset().city, '.json')",
							"type": "Expression"
						},
						"folderPath": "AirQuality",
						"container": "data"
					}
				},
				"schema": {}
			},
			"dependsOn": [
				"[concat(variables('factoryId'), '/linkedServices/ds_json_data')]"
			]
		},
		{
			"name": "[concat(parameters('factoryName'), '/ds_processes_weather_data')]",
			"type": "Microsoft.DataFactory/factories/datasets",
			"apiVersion": "2018-06-01",
			"properties": {
				"linkedServiceName": {
					"referenceName": "ls_adls_gen2",
					"type": "LinkedServiceReference"
				},
				"annotations": [],
				"type": "DelimitedText",
				"typeProperties": {
					"location": {
						"type": "AzureBlobFSLocation",
						"folderPath": "weather/raw",
						"fileSystem": "data"
					},
					"columnDelimiter": ",",
					"escapeChar": "\\",
					"firstRowAsHeader": true,
					"quoteChar": "\""
				},
				"schema": []
			},
			"dependsOn": [
				"[concat(variables('factoryId'), '/linkedServices/ls_adls_gen2')]"
			]
		},
		{
			"name": "[concat(parameters('factoryName'), '/ds_rest_api_data')]",
			"type": "Microsoft.DataFactory/factories/datasets",
			"apiVersion": "2018-06-01",
			"properties": {
				"linkedServiceName": {
					"referenceName": "airQualityAPI",
					"type": "LinkedServiceReference"
				},
				"parameters": {
					"URL_path": {
						"type": "string"
					},
					"token": {
						"type": "string"
					}
				},
				"annotations": [],
				"type": "RestResource",
				"typeProperties": {
					"relativeUrl": {
						"value": "@concat(dataset().URL_path, dataset().token)",
						"type": "Expression"
					}
				},
				"schema": []
			},
			"dependsOn": [
				"[concat(variables('factoryId'), '/linkedServices/airQualityAPI')]"
			]
		},
		{
			"name": "[concat(parameters('factoryName'), '/ds_weatherAPI')]",
			"type": "Microsoft.DataFactory/factories/datasets",
			"apiVersion": "2018-06-01",
			"properties": {
				"linkedServiceName": {
					"referenceName": "weatherAPI",
					"type": "LinkedServiceReference"
				},
				"parameters": {
					"location": {
						"type": "string"
					},
					"date": {
						"type": "string"
					},
					"apiKey": {
						"type": "string"
					}
				},
				"annotations": [],
				"type": "RestResource",
				"typeProperties": {
					"relativeUrl": {
						"value": "@concat(dataset().location,dataset().date,dataset().apiKey)",
						"type": "Expression"
					}
				},
				"schema": []
			},
			"dependsOn": [
				"[concat(variables('factoryId'), '/linkedServices/weatherAPI')]"
			]
		},
		{
			"name": "[concat(parameters('factoryName'), '/ds_weatherData_json')]",
			"type": "Microsoft.DataFactory/factories/datasets",
			"apiVersion": "2018-06-01",
			"properties": {
				"linkedServiceName": {
					"referenceName": "ds_json_data",
					"type": "LinkedServiceReference"
				},
				"parameters": {
					"city": {
						"type": "string"
					},
					"file_type": {
						"type": "string"
					}
				},
				"annotations": [],
				"type": "Json",
				"typeProperties": {
					"location": {
						"type": "AzureBlobStorageLocation",
						"fileName": {
							"value": "@concat(dataset().city, dataset().file_type)",
							"type": "Expression"
						},
						"folderPath": "weather_data",
						"container": "data"
					}
				},
				"schema": {}
			},
			"dependsOn": [
				"[concat(variables('factoryId'), '/linkedServices/ds_json_data')]"
			]
		},
		{
			"name": "[concat(parameters('factoryName'), '/airQualityAPI')]",
			"type": "Microsoft.DataFactory/factories/linkedServices",
			"apiVersion": "2018-06-01",
			"properties": {
				"annotations": [],
				"type": "RestService",
				"typeProperties": {
					"url": "[parameters('airQualityAPI_properties_typeProperties_url')]",
					"enableServerCertificateValidation": true,
					"authenticationType": "Anonymous"
				}
			},
			"dependsOn": []
		},
		{
			"name": "[concat(parameters('factoryName'), '/ds_json_data')]",
			"type": "Microsoft.DataFactory/factories/linkedServices",
			"apiVersion": "2018-06-01",
			"properties": {
				"annotations": [],
				"type": "AzureBlobStorage",
				"typeProperties": {
					"connectionString": "[parameters('ds_json_data_connectionString')]"
				}
			},
			"dependsOn": []
		},
		{
			"name": "[concat(parameters('factoryName'), '/ls_adls_gen2')]",
			"type": "Microsoft.DataFactory/factories/linkedServices",
			"apiVersion": "2018-06-01",
			"properties": {
				"annotations": [],
				"type": "AzureBlobFS",
				"typeProperties": {
					"url": "[parameters('ls_adls_gen2_properties_typeProperties_url')]",
					"accountKey": {
						"type": "SecureString",
						"value": "[parameters('ls_adls_gen2_accountKey')]"
					}
				}
			},
			"dependsOn": []
		},
		{
			"name": "[concat(parameters('factoryName'), '/weatherAPI')]",
			"type": "Microsoft.DataFactory/factories/linkedServices",
			"apiVersion": "2018-06-01",
			"properties": {
				"annotations": [],
				"type": "RestService",
				"typeProperties": {
					"url": "[parameters('weatherAPI_properties_typeProperties_url')]",
					"enableServerCertificateValidation": true,
					"authenticationType": "Anonymous"
				}
			},
			"dependsOn": []
		},
		{
			"name": "[concat(parameters('factoryName'), '/weather_data_df')]",
			"type": "Microsoft.DataFactory/factories/dataflows",
			"apiVersion": "2018-06-01",
			"properties": {
				"type": "MappingDataFlow",
				"typeProperties": {
					"sources": [
						{
							"dataset": {
								"referenceName": "ds_weatherData_json",
								"type": "DatasetReference"
							},
							"name": "weatherDataRaw"
						}
					],
					"sinks": [
						{
							"dataset": {
								"referenceName": "ds_processes_weather_data",
								"type": "DatasetReference"
							},
							"name": "processedWeatherData"
						}
					],
					"transformations": [
						{
							"name": "extractColumns"
						},
						{
							"name": "select1"
						}
					],
					"scriptLines": [
						"source(output(",
						"          address as string,",
						"          alerts as string[],",
						"          currentConditions as (cloudcover as double, conditions as string, datetime as string, datetimeEpoch as integer, dew as double, feelslike as double, humidity as double, icon as string, moonphase as double, precip as double, precipprob as double, preciptype as string, pressure as double, snow as double, snowdepth as double, solarenergy as double, solarradiation as double, source as string, stations as string[], sunrise as string, sunriseEpoch as integer, sunset as string, sunsetEpoch as integer, temp as double, uvindex as double, visibility as double, winddir as double, windgust as string, windspeed as double),",
						"          days as (cloudcover as double, conditions as string, datetime as date, datetimeEpoch as integer, description as string, dew as double, feelslike as double, feelslikemax as double, feelslikemin as double, hours as (cloudcover as double, conditions as string, datetime as string, datetimeEpoch as integer, dew as double, feelslike as double, humidity as double, icon as string, precip as double, precipprob as double, preciptype as string, pressure as double, severerisk as double, snow as double, snowdepth as double, solarenergy as double, solarradiation as double, source as string, stations as string[], temp as double, uvindex as double, visibility as double, winddir as double, windgust as double, windspeed as double)[], humidity as double, icon as string, moonphase as double, precip as double, precipcover as double, precipprob as double, preciptype as string, pressure as double, severerisk as double, snow as double, snowdepth as double, solarenergy as double, solarradiation as double, source as string, stations as string[], sunrise as string, sunriseEpoch as integer, sunset as string, sunsetEpoch as integer, temp as double, tempmax as double, tempmin as double, uvindex as double, visibility as double, winddir as double, windgust as double, windspeed as double)[],",
						"          description as string,",
						"          latitude as double,",
						"          longitude as double,",
						"          queryCost as boolean,",
						"          resolvedAddress as string,",
						"          stations as (C0449 as (contribution as double, distance as double, id as string, latitude as double, longitude as double, name as string, quality as boolean, useCount as boolean), D3248 as (contribution as double, distance as double, id as string, latitude as double, longitude as double, name as string, quality as boolean, useCount as boolean), EHAM as (contribution as double, distance as double, id as string, latitude as double, longitude as double, name as string, quality as short, useCount as boolean), EHKD as (contribution as double, distance as double, id as string, latitude as double, longitude as double, name as string, quality as short, useCount as boolean), EHLE as (contribution as double, distance as double, id as string, latitude as double, longitude as double, name as string, quality as short, useCount as boolean), EHRD as (contribution as double, distance as double, id as string, latitude as double, longitude as double, name as string, quality as short, useCount as boolean)),",
						"          timezone as string,",
						"          tzoffset as double",
						"     ),",
						"     allowSchemaDrift: true,",
						"     validateSchema: false,",
						"     ignoreNoFilesFound: false,",
						"     documentForm: 'documentPerLine') ~> weatherDataRaw",
						"weatherDataRaw derive(datetime = days.datetime,",
						"          datetimeEpoch = days.datetimeEpoch,",
						"          tempmax = days.tempmax,",
						"          tempmin = days.tempmin,",
						"          temp = days.temp,",
						"          feelslikemax = days.feelslikemax,",
						"          feelslikemin = days.feelslikemin,",
						"          feelslike = days.feelslike,",
						"          humidity = days.humidity,",
						"          dew = days.dew,",
						"          precip = days.precip,",
						"          precipprob = days.precipprob,",
						"          snow = days.snow,",
						"          snowdepth = days.snowdepth,",
						"          preciptype = days.preciptype,",
						"          precipcover = days.precipcover,",
						"          windgust = days.windgust,",
						"          windspeed = days.windspeed,",
						"          winddir = days.winddir,",
						"          pressure = days.pressure,",
						"          visibility = days.visibility,",
						"          cloudcover = days.cloudcover,",
						"          solarradiation = days.solarradiation,",
						"          solarenergy = days.solarenergy,",
						"          uvindex = days.uvindex,",
						"          conditions = days.conditions,",
						"          icon = days.icon,",
						"          stations = days.stations,",
						"          source = days.source,",
						"          sunrise = days.sunrise,",
						"          sunriseEpoch = days.sunriseEpoch,",
						"          sunset = days.sunset,",
						"          sunsetEpoch = days.sunriseEpoch,",
						"          moonphase = days.moonphase) ~> extractColumns",
						"extractColumns select(mapColumn(",
						"          address,",
						"          description,",
						"          latitude,",
						"          longitude,",
						"          resolvedAddress,",
						"          stations,",
						"          timezone,",
						"          tzoffset,",
						"          datetime,",
						"          datetimeEpoch,",
						"          tempmax,",
						"          tempmin,",
						"          temp,",
						"          feelslikemax,",
						"          feelslikemin,",
						"          feelslike,",
						"          humidity,",
						"          dew,",
						"          precip,",
						"          precipprob,",
						"          snow,",
						"          snowdepth,",
						"          preciptype,",
						"          precipcover,",
						"          windgust,",
						"          windspeed,",
						"          winddir,",
						"          pressure,",
						"          visibility,",
						"          cloudcover,",
						"          solarradiation,",
						"          solarenergy,",
						"          uvindex,",
						"          conditions,",
						"          icon,",
						"          source,",
						"          sunrise,",
						"          sunriseEpoch,",
						"          sunset,",
						"          sunsetEpoch,",
						"          moonphase",
						"     ),",
						"     skipDuplicateMapInputs: true,",
						"     skipDuplicateMapOutputs: true) ~> select1",
						"select1 sink(allowSchemaDrift: true,",
						"     validateSchema: false,",
						"     umask: 0022,",
						"     preCommands: [],",
						"     postCommands: [],",
						"     skipDuplicateMapInputs: true,",
						"     skipDuplicateMapOutputs: true) ~> processedWeatherData"
					]
				}
			},
			"dependsOn": [
				"[concat(variables('factoryId'), '/datasets/ds_weatherData_json')]",
				"[concat(variables('factoryId'), '/datasets/ds_processes_weather_data')]"
			]
		}
	]
}